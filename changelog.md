# Changelog: История изменений проекта «Trimspire Menu Generator»

Этот документ отслеживает все задачи, внесенные изменения в кодовую базу и результаты этих изменений в ходе нашей совместной работы.

---

## Задача №1: Создание основы проекта и настройка окружения

### Задача
Нужно было создать «фундамент» для нового продукта: инициализировать проект на Next.js, установить базовые библиотеки, настроить систему контроля версий Git и связать ее с удаленным репозиторием.

### Изменения
* **Анализ:** В качестве основного стека был выбран **Next.js** с поддержкой **TypeScript**. Для стилизации — библиотека **Styled Components**. Для контроля версий — **Git** с подключением к удаленному репозиторию по **SSH**.
* **Код:**
    * Создан новый проект `trimspire-menu-generator` с помощью команды `npx create-next-app@latest .`.
    * Установлена зависимость `styled-components`.
    * С помощью `git init` создан локальный репозиторий.
    * С помощью команд `git remote add origin` и `git push` локальный репозиторий был связан с удаленным на GitHub, и в него был отправлен первоначальный код.
* **Окружение:** На локальном компьютере создана папка проекта. На GitHub создан новый пустой приватный репозиторий. Настроен SSH-ключ для безопасного соединения между локальной машиной и GitHub.

### Результат
* **Успех.** Проект был успешно создан, сконфигурирован и запущен локально. Код надежно сохранен в удаленном репозитории. Фундамент для дальнейшей разработки полностью заложен.

---

## Задача №2: Настройка базы данных с помощью Prisma

### Задача
Спроектировать и настроить структуру базы данных (БД) для будущего продукта. Необходимо было описать все таблицы, поля и связи между ними, используя современный и безопасный инструмент.

### Изменения
* **Анализ:** Для работы с БД была выбрана связка **PostgreSQL** и **Prisma ORM**. Этот подход обеспечивает строгую типизацию, безопасность и удобство при написании запросов. Схема была спроектирована так, чтобы хранить данные о пользователях, их ответах на квиз, подписках, а также полную информацию о рецептах, ингредиентах и тегах.
* **Код:**
    * Установлены зависимости `prisma` и `@prisma/client`.
    * С помощью команды `npx prisma init` была создана директория `prisma` и конфигурационный файл `schema.prisma`.
    * В файл `schema.prisma` была добавлена полная, детально проработанная схема всех таблиц (`User`, `QuizAnswers`, `Recipe`, `Ingredient` и др.) и связей между ними.
    * Создан файл `.env` для безопасного хранения строки подключения к базе данных.
    * С помощью `npx prisma generate` был сгенерирован типизированный клиент Prisma для взаимодействия с БД из кода.

### Результат
* **Успех.** База данных полностью спроектирована и описана в виде Prisma-схемы. Проект готов к следующему шагу — созданию таблиц в реальной БД на основе этой схемы и разработке API для работы с данными.

---

## Задача №3: Настройка API и подключение к базе данных

### Задача
Настроить API-эндпоинт для приема данных из анкеты и обеспечить его успешное подключение к реальной базе данных для сохранения информации, устранив все ошибки, возникающие при передаче данных.

### Изменения
* **Анализ:** Были выявлены и решены две последовательные проблемы:
    1.  **CORS (Cross-Origin Resource Sharing):** Браузер блокировал запросы от проекта "Анкета" (`localhost:3000`) к проекту "Генератор меню" (`localhost:3001`). Проблема решена путем настройки разрешающих заголовков на стороне сервера.
    2.  **Ошибка подключения к БД:** Prisma не могла подключиться к базе данных, так как она физически не существовала. Было решено создать и настроить локальную базу данных PostgreSQL.
* **Код:**
    * **Проект «Генератор меню»:**
        * Установлена библиотека `cors` для управления междоменными запросами.
        * В API-роут `src/pages/api/quiz/save.ts` добавлена логика `cors`, разрешающая запросы с `http://localhost:3000`.
        * Файл `.env` был обновлен для использования корректной строки подключения к локальной БД.
        * Выполнена команда `npx prisma db push`, которая синхронизировала схему Prisma с реальной базой данных и создала в ней все необходимые таблицы.
    * **Проект «Анкета»:**
        * В компонент `src/components/screens/EmailScreen.tsx` добавлена логика `fetch` для отправки данных (email и ответы) на эндпоинт `http://localhost:3001/api/quiz/save`.
* **Окружение:**
    * С помощью `psql` в локальном PostgreSQL созданы новый пользователь `trimspire_user` и новая база данных `trimspire_db` специально для этого проекта.

### Результат
* **Успех.** Связь между двумя проектами успешно установлена. Данные из анкеты корректно отправляются, принимаются сервером и сохраняются в локальную базу данных PostgreSQL. Все ошибки подключения и передачи данных устранены.

---

## Задача №4: Рефакторинг системы аутентификации на использование паролей

### Задача
Перестроить систему входа с временных "магических ссылок" на более традиционную и постоянную систему с установкой и проверкой пароля, согласно новому, утвержденному флоу пользователя.

### Изменения
* **Анализ:** Предыдущая система "магических ссылок" была предназначена для беспарольного входа, но не предполагала создание постоянного аккаунта с паролем. Новая архитектура требует хранения хэша пароля в БД и разделения логики на два этапа: 1) установка пароля по уникальной ссылке из письма и 2) последующий вход в систему по паре email/пароль.
* **Код:**
    * **Проект «Генератор меню»:**
        * Установлена библиотека `bcryptjs` для безопасного хэширования паролей.
        * В `schema.prisma` в модель `User` добавлено необязательное поле `password: String?`. Структура таблицы в PostgreSQL обновлена командой `npx prisma db push`.
        * API-эндпоинт `/api/quiz/save.ts` был переработан: теперь после сохранения ответов он генерирует JWT-токен и отправляет пользователю на email ссылку, ведущую на страницу **создания пароля**.
* **Окружение:** Изменена структура таблицы `User` в локальной базе данных PostgreSQL.

### Результат
* **Успех.** Бэкенд-часть системы аутентификации была успешно перестроена. Теперь после прохождения анкеты пользователь получает на почту ссылку для установки пароля, что полностью готовит нас к созданию интерфейса для этого процесса.

---

## Задача №5: Завершение и отладка системы аутентификации

### Задача
Завершить реализацию новой системы аутентификации на основе паролей, создав недостающие страницы интерфейса и API. Устранить проблему с "невидимыми" тестовыми письмами для упрощения дальнейшей отладки.

### Изменения
* **Анализ:**
    1.  Для завершения нового флоу требовалось создать интерфейс, где пользователь мог бы установить пароль, и финальную страницу входа.
    2.  Была выявлена проблема с тестированием отправки email: сервис `Ethereal` корректно перехватывал письма, но ссылка на их предпросмотр не выводилась, что создавало иллюзию "неотправки". Решено было добавить логирование этой ссылки.
* **Код:**
    * **Проект «Генератор меню»:**
        * Создан новый API-эндпоинт `/api/auth/set-password.ts` для проверки токена, хэширования и сохранения нового пароля пользователя в БД.
        * Создана новая фронтенд-страница `/set-password.tsx` с формой для ввода и подтверждения пароля.
        * API-эндпоинт `/api/auth/login.ts` был полностью переписан для проверки email и пароля, сравнения хэшей и создания сессии через cookie.
        * Фронтенд-страница `/login.tsx` была обновлена до полноценной формы входа с полями для email и пароля.
        * В API-эндпоинт `/api/quiz/save.ts` добавлено логирование `nodemailer.getTestMessageUrl(info)`, чтобы в консоли сервера всегда была прямая ссылка на перехваченное Ethereal письмо.
* **Окружение:** Установлены библиотеки `cookie`, `bcryptjs` и их TypeScript-типы.

### Результат
* **Успех.** Система аутентификации полностью завершена и работает в соответствии с новым флоу. Пользователь может установить пароль по ссылке и войти в систему. Проблема с тестовыми письмами решена, процесс отладки стал прозрачным и удобным.

---

## Задача №6: Отладка и исправление системы защиты страниц

### Задача
Устранить критический баг в системе безопасности: защищенная страница `/dashboard` была доступна неавторизованным пользователям. Найти причину, по которой middleware не срабатывал, и внедрить надежное решение.

### Изменения
* **Анализ:**
    * После добавления логов стало очевидно, что файл `middleware.ts` полностью игнорируется сборщиком Next.js, несмотря на правильное расположение. Причина осталась невыясненной, но проблема требовала немедленного решения.
    * Было принято решение отказаться от middleware в пользу более надежного и явного метода защиты страниц — через функцию `getServerSideProps`, которая выполняется на сервере перед отрисовкой страницы.
    * Параллельно была обнаружена и устранена ошибка `API Routes cannot be used with "output: export"` в проекте с анкетой, мешавшая его запуску.
* **Код:**
    * **Проект «Анкета» (`trimspire-clone`):** Удалена неиспользуемая папка `src/pages/api`, что устранило ошибку при запуске сервера разработки.
    * **Проект «Генератор меню» (`trimspire-menu-generator`):**
        * Файл `middleware.ts` был удален, чтобы избежать дальнейшей путаницы.
        * В файл `src/pages/dashboard.tsx` добавлена функция `getServerSideProps`. Внутри нее реализована логика проверки наличия и валидности `auth_token` из cookie. Если проверка не проходит, пользователь принудительно перенаправляется на страницу `/login` на стороне сервера.

### Результат
* **Успех.** Система защиты страниц полностью исправлена и работает надежно. Страница `/dashboard` теперь недоступна для неавторизованных пользователей. Проблема с запуском второго проекта также решена.

---

## Задача №7: Стабилизация и отладка базы данных для генерации меню

### Задача
Подготовить базу данных к реализации основной логики продукта — генерации меню. Необходимо было внести изменения в схему, устранить накопившиеся ошибки миграций, отладить процесс заполнения тестовыми данными и обеспечить стабильность всего процесса.

### Изменения
* **Анализ:**
    * Для упрощения алгоритма генерации было решено добавить поле `mealType` (`BREAKFAST`, `LUNCH`, `DINNER`) напрямую в модель `Recipe`.
    * В ходе работы были выявлены и последовательно устранены три критические проблемы:
        1.  **Ошибка прав доступа (`P3014`):** Пользователь PostgreSQL не имел прав `CREATEDB`, необходимых для работы теневой базы данных Prisma.
        2.  **Рассинхронизация схемы (`Drift detected`):** Предыдущее использование `db push` привело к тому, что реальная структура БД не соответствовала истории миграций.
        3.  **Ошибка типизации в `seed.ts`:** После добавления нового поля `mealType` в схему, скрипт заполнения перестал проходить проверку типов TypeScript.
* **Код:**
    * **`prisma/schema.prisma`:** В модель `Recipe` добавлено обязательное поле `mealType: String`.
    * **`prisma/seed.ts`:** Все тестовые рецепты обновлены с добавлением поля `mealType`. Логика очистки и создания данных была проверена и подтверждена.
    * **`package.json` & `tsconfig.seed.json`:** Команда `db seed` была исправлена для корректной работы с `ts-node` путем создания отдельного файла `tsconfig.seed.json`, что решило проблемы с обработкой кавычек в терминале.
* **Окружение:**
    * Для пользователя `trimspire_user` в PostgreSQL были выданы права на создание баз данных (`CREATEDB`).
    * Выполнена команда `npx prisma migrate reset`, которая полностью очистила базу данных и создала её заново на основе чистой, корректной истории миграций.
    * База данных была повторно заполнена исправленным seed-скриптом.

### Результат
* **Успех.** База данных полностью отлажена, её структура актуализирована и соответствует коду. Процесс миграций и заполнения тестовыми данными теперь стабилен и надёжен. Все технические препятствия для реализации API генерации меню устранены.

---

## Задача №8: Редизайн и стилизация страницы Дашборда

### Задача
Привести внешний вид страницы с планом питания (`/dashboard`) в соответствие с визуальным стилем проекта «Анкета». Необходимо было обновить фон, цветовую палитру, шрифты, скругления и общую компоновку элементов для создания единого и профессионального пользовательского опыта.

### Изменения
* **Анализ:** Было решено отказаться от базовых стилей в пользу более современного и чистого дизайна. Основные принципы: светлый фон, акцентные цвета для ключевых элементов, улучшенная читаемость и адаптивность под мобильные устройства.
* **Код:**
    * **`src/app/globals.css`:** Файл был полностью обновлен. Установлен глобальный светло-серый фон (`#f0f2f5`), подключен и применен шрифт "Inter". Внедрены CSS-переменные для управления основной цветовой палитрой и скруглениями (`--border-radius: 12px`).
    * **`src/app/dashboard/Dashboard.module.css`:** Файл стилей дашборда был полностью переписан. Реализована новая сеточная структура (7 колонок по дням недели), обновлены карточки блюд — они получили тени, увеличенные скругления и эффект приподнимания при наведении. Добавлены стили для заголовков и акцентные цвета для типов приёма пищи. Реализована медиа-запрос для корректного отображения на мобильных устройствах.

### Результат
* **Успех.** Страница дашборда полностью преобразилась. Новый интерфейс выглядит современно, профессионально и интуитивно понятно. Визуальный стиль теперь гармонирует с общей концепцией продукта, улучшена адаптивность и интерактивность элементов.

---

## Задача №9: Функциональное и визуальное обновление Дашборда

### Задача
Провести комплексное обновление страницы дашборда, добавив новые информационные блоки, полностью изменив структуру отображения меню и обогатив внешний вид карточек с рецептами.

### Изменения
* **Анализ:** Текущий дизайн был слишком простым. Требовалось добавить больше персонализированной информации (вес, КБЖУ) и сделать навигацию по дням недели более удобной. Было решено перейти от сплошной сетки к системе с вертикальными табами, что позволяет пользователю фокусироваться на одном дне, не теряя контекста всей недели.
* **Код:**
    * **API (`src/app/api/menu/generate/route.ts`):** Логика API была расширена. Теперь, помимо генерации меню, она также запрашивает из базы данных ответы пользователя на анкету (`QuizAnswers`) и возвращает на фронтенд его текущий и желаемый вес.
    * **База данных (`prisma/seed.ts`):** Скрипт заполнения тестовыми данными был обновлен. Для всех рецептов добавлено поле `imageUrl` со ссылкой на изображение-заглушку `/images/reciept.jpg`, чтобы подготовить основу для нового дизайна карточек.
    * **Компонент дашборда (`src/app/dashboard/page.tsx`):**
        * Добавлено состояние для отслеживания активного дня недели (таба).
        * Реализован вывод данных о текущем и желаемом весе пользователя в хедере страницы.
        * Добавлен статический блок с рекомендуемыми КБЖУ и эмодзи.
        * Вся верстка перестроена на новую структуру: слева — блок с кликабельными табами дней недели, справа — сетка из трех колонок для отображения рецептов выбранного дня.
    * **Стили дашборда (`src/app/dashboard/Dashboard.module.css`):**
        * Файл стилей был полностью переписан для поддержки новой двухколоночной структуры с табами.
        * Добавлены стили для активного таба и эффекта при наведении.
        * Карточка рецепта полностью переработана: теперь она включает блок для изображения, заголовок, краткое описание (до 100 символов) и нижний блок с отображением КБЖУ с помощью эмодзи.

### Результат
* **Успех.** Дашборд стал значительно более информативным и интерактивным. Пользователь сразу видит свои ключевые метрики (вес) и рекомендации. Новая структура с табами улучшила навигацию и организацию контента. Карточки рецептов стали визуально привлекательнее и содержат больше полезной информации в компактном виде.

---

## Задача №10: Реализация расчёта КБЖУ и отладка сохранения данных

### Задача
Нужно было реализовать ключевую функцию продукта: расчёт персональной нормы калорий, белков, жиров и углеводов (КБЖУ) на основе ответов пользователя в анкете. Результаты должны были динамически отображаться в блоке «Мы рекомендуем» на дашборде.

### Изменения
* **Анализ:** Для реализации был выбран подход с вынесением всей математической логики в отдельный модуль-калькулятор. Была решена проблема с использованием диапазона возраста в формуле путём вычисления среднего арифметического значения (например, для "26-35" используется возраст 30.5).

* **Код:**
    * **`src/app/api/menu/generate/utils.ts`:** Создан новый файл, содержащий всю логику расчёта КБЖУ по предоставленным формулам.
    * **`src/app/api/menu/generate/route.ts`:** API-эндпоинт был обновлён. Теперь он импортирует и вызывает `calculateMacros` из `utils.ts`, передавая в него ответы пользователя из БД. Рассчитанные КБЖУ добавляются в ответ API.
    * **`src/app/dashboard/page.tsx`:** Компонент дашборда был доработан для приёма и отображения динамически рассчитанных КБЖУ. Статические значения заменены на данные из API.

* **Отладка (Debugging):** В ходе реализации были выявлены и устранены две критические проблемы, мешавшие работе всей системы.
    1.  **Данные не сохранялись:** Было обнаружено, что ответы из анкеты вообще не попадали в базу данных из-за заглушки (`// TODO:`) в файле `/api/quiz/save.ts`. Была реализована полная логика сопоставления (маппинга) ответов на вопросы с полями в таблице `QuizAnswers`.
    2.  **Несоответствие типов данных:** После исправления сохранения возникла ошибка `PrismaClientValidationError`. Анализ логов показал, что схема базы данных (`prisma/schema.prisma`) некорректно описывала типы данных для вопросов с множественным выбором (ожидала `String`, а получала `String[]`). Схема была полностью переработана, чтобы точно соответствовать всем типам вопросов в анкете.

### Результат
* **Успех.** Функция расчёта КБЖУ полностью реализована и работает корректно. Дашборд теперь показывает пользователю его персональные, научно обоснованные рекомендации. Все проблемы с сохранением и структурой данных в базе были полностью устранены, что делает систему стабильной и готовой к дальнейшему расширению.

---

## Задача №11: Редизайн кнопки выхода из системы

### Задача
Улучшить пользовательский опыт на странице дашборда, заменив текстовую кнопку "Выйти", расположенную внизу страницы, на более интуитивную и всегда доступную иконку-эмодзи в правом верхнем углу.

### Изменения
* **Анализ:** Было принято решение отказаться от кнопки в футере, так как она требовала от пользователя полной прокрутки страницы для доступа. Новый элемент — иконка `🚪` — размещён в правом верхнем углу с использованием абсолютного позиционирования, что делает его видимым независимо от скролла.
* **Код:**
    * **`src/app/dashboard/page.tsx`:** Удалена старая кнопка выхода. В верхнюю часть контейнера страницы добавлена новая кнопка с эмодзи `🚪`, к которой привязан тот же обработчик `handleLogout`.
    * **`src/app/dashboard/Dashboard.module.css`:** Удалены стили для старого класса `.logoutButton`. Добавлены новые стили для `.logoutIcon` (`position: absolute`, `top`, `right`) и добавлено свойство `position: relative` к родительскому контейнеру `.container` для корректного позиционирования.

### Результат
* **Успех.** Функция выхода из системы теперь доступна через иконку в правом верхнем углу дашборда. Это освободило нижнюю часть страницы, сделало интерфейс чище и улучшило навигацию для пользователя.

---