# Changelog: История изменений проекта «Trimspire Menu Generator»

Этот документ отслеживает все задачи, внесенные изменения в кодовую базу и результаты этих изменений в ходе нашей совместной работы.

---

## Задача №1: Создание основы проекта и настройка окружения

### Задача
Нужно было создать «фундамент» для нового продукта: инициализировать проект на Next.js, установить базовые библиотеки, настроить систему контроля версий Git и связать ее с удаленным репозиторием.

### Изменения
* **Анализ:** В качестве основного стека был выбран **Next.js** с поддержкой **TypeScript**. Для стилизации — библиотека **Styled Components**. Для контроля версий — **Git** с подключением к удаленному репозиторию по **SSH**.
* **Код:**
    * Создан новый проект `trimspire-menu-generator` с помощью команды `npx create-next-app@latest .`.
    * Установлена зависимость `styled-components`.
    * С помощью `git init` создан локальный репозиторий.
    * С помощью команд `git remote add origin` и `git push` локальный репозиторий был связан с удаленным на GitHub, и в него был отправлен первоначальный код.
* **Окружение:** На локальном компьютере создана папка проекта. На GitHub создан новый пустой приватный репозиторий. Настроен SSH-ключ для безопасного соединения между локальной машиной и GitHub.

### Результат
* **Успех.** Проект был успешно создан, сконфигурирован и запущен локально. Код надежно сохранен в удаленном репозитории. Фундамент для дальнейшей разработки полностью заложен.

---

## Задача №2: Настройка базы данных с помощью Prisma

### Задача
Спроектировать и настроить структуру базы данных (БД) для будущего продукта. Необходимо было описать все таблицы, поля и связи между ними, используя современный и безопасный инструмент.

### Изменения
* **Анализ:** Для работы с БД была выбрана связка **PostgreSQL** и **Prisma ORM**. Этот подход обеспечивает строгую типизацию, безопасность и удобство при написании запросов. Схема была спроектирована так, чтобы хранить данные о пользователях, их ответах на квиз, подписках, а также полную информацию о рецептах, ингредиентах и тегах.
* **Код:**
    * Установлены зависимости `prisma` и `@prisma/client`.
    * С помощью команды `npx prisma init` была создана директория `prisma` и конфигурационный файл `schema.prisma`.
    * В файл `schema.prisma` была добавлена полная, детально проработанная схема всех таблиц (`User`, `QuizAnswers`, `Recipe`, `Ingredient` и др.) и связей между ними.
    * Создан файл `.env` для безопасного хранения строки подключения к базе данных.
    * С помощью `npx prisma generate` был сгенерирован типизированный клиент Prisma для взаимодействия с БД из кода.

### Результат
* **Успех.** База данных полностью спроектирована и описана в виде Prisma-схемы. Проект готов к следующему шагу — созданию таблиц в реальной БД на основе этой схемы и разработке API для работы с данными.

---

## Задача №3: Настройка API и подключение к базе данных

### Задача
Настроить API-эндпоинт для приема данных из анкеты и обеспечить его успешное подключение к реальной базе данных для сохранения информации, устранив все ошибки, возникающие при передаче данных.

### Изменения
* **Анализ:** Были выявлены и решены две последовательные проблемы:
    1.  **CORS (Cross-Origin Resource Sharing):** Браузер блокировал запросы от проекта "Анкета" (`localhost:3000`) к проекту "Генератор меню" (`localhost:3001`). Проблема решена путем настройки разрешающих заголовков на стороне сервера.
    2.  **Ошибка подключения к БД:** Prisma не могла подключиться к базе данных, так как она физически не существовала. Было решено создать и настроить локальную базу данных PostgreSQL.
* **Код:**
    * **Проект «Генератор меню»:**
        * Установлена библиотека `cors` для управления междоменными запросами.
        * В API-роут `src/pages/api/quiz/save.ts` добавлена логика `cors`, разрешающая запросы с `http://localhost:3000`.
        * Файл `.env` был обновлен для использования корректной строки подключения к локальной БД.
        * Выполнена команда `npx prisma db push`, которая синхронизировала схему Prisma с реальной базой данных и создала в ней все необходимые таблицы.
    * **Проект «Анкета»:**
        * В компонент `src/components/screens/EmailScreen.tsx` добавлена логика `fetch` для отправки данных (email и ответы) на эндпоинт `http://localhost:3001/api/quiz/save`.
* **Окружение:**
    * С помощью `psql` в локальном PostgreSQL созданы новый пользователь `trimspire_user` и новая база данных `trimspire_db` специально для этого проекта.

### Результат
* **Успех.** Связь между двумя проектами успешно установлена. Данные из анкеты корректно отправляются, принимаются сервером и сохраняются в локальную базу данных PostgreSQL. Все ошибки подключения и передачи данных устранены.

---

## Задача №4: Рефакторинг системы аутентификации на использование паролей

### Задача
Перестроить систему входа с временных "магических ссылок" на более традиционную и постоянную систему с установкой и проверкой пароля, согласно новому, утвержденному флоу пользователя.

### Изменения
* **Анализ:** Предыдущая система "магических ссылок" была предназначена для беспарольного входа, но не предполагала создание постоянного аккаунта с паролем. Новая архитектура требует хранения хэша пароля в БД и разделения логики на два этапа: 1) установка пароля по уникальной ссылке из письма и 2) последующий вход в систему по паре email/пароль.
* **Код:**
    * **Проект «Генератор меню»:**
        * Установлена библиотека `bcryptjs` для безопасного хэширования паролей.
        * В `schema.prisma` в модель `User` добавлено необязательное поле `password: String?`. Структура таблицы в PostgreSQL обновлена командой `npx prisma db push`.
        * API-эндпоинт `/api/quiz/save.ts` был переработан: теперь после сохранения ответов он генерирует JWT-токен и отправляет пользователю на email ссылку, ведущую на страницу **создания пароля**.
* **Окружение:** Изменена структура таблицы `User` в локальной базе данных PostgreSQL.

### Результат
* **Успех.** Бэкенд-часть системы аутентификации была успешно перестроена. Теперь после прохождения анкеты пользователь получает на почту ссылку для установки пароля, что полностью готовит нас к созданию интерфейса для этого процесса.

---

## Задача №5: Завершение и отладка системы аутентификации

### Задача
Завершить реализацию новой системы аутентификации на основе паролей, создав недостающие страницы интерфейса и API. Устранить проблему с "невидимыми" тестовыми письмами для упрощения дальнейшей отладки.

### Изменения
* **Анализ:**
    1.  Для завершения нового флоу требовалось создать интерфейс, где пользователь мог бы установить пароль, и финальную страницу входа.
    2.  Была выявлена проблема с тестированием отправки email: сервис `Ethereal` корректно перехватывал письма, но ссылка на их предпросмотр не выводилась, что создавало иллюзию "неотправки". Решено было добавить логирование этой ссылки.
* **Код:**
    * **Проект «Генератор меню»:**
        * Создан новый API-эндпоинт `/api/auth/set-password.ts` для проверки токена, хэширования и сохранения нового пароля пользователя в БД.
        * Создана новая фронтенд-страница `/set-password.tsx` с формой для ввода и подтверждения пароля.
        * API-эндпоинт `/api/auth/login.ts` был полностью переписан для проверки email и пароля, сравнения хэшей и создания сессии через cookie.
        * Фронтенд-страница `/login.tsx` была обновлена до полноценной формы входа с полями для email и пароля.
        * В API-эндпоинт `/api/quiz/save.ts` добавлено логирование `nodemailer.getTestMessageUrl(info)`, чтобы в консоли сервера всегда была прямая ссылка на перехваченное Ethereal письмо.
* **Окружение:** Установлены библиотеки `cookie`, `bcryptjs` и их TypeScript-типы.

### Результат
* **Успех.** Система аутентификации полностью завершена и работает в соответствии с новым флоу. Пользователь может установить пароль по ссылке и войти в систему. Проблема с тестовыми письмами решена, процесс отладки стал прозрачным и удобным.

---

## Задача №6: Отладка и исправление системы защиты страниц

### Задача
Устранить критический баг в системе безопасности: защищенная страница `/dashboard` была доступна неавторизованным пользователям. Найти причину, по которой middleware не срабатывал, и внедрить надежное решение.

### Изменения
* **Анализ:**
    * После добавления логов стало очевидно, что файл `middleware.ts` полностью игнорируется сборщиком Next.js, несмотря на правильное расположение. Причина осталась невыясненной, но проблема требовала немедленного решения.
    * Было принято решение отказаться от middleware в пользу более надежного и явного метода защиты страниц — через функцию `getServerSideProps`, которая выполняется на сервере перед отрисовкой страницы.
    * Параллельно была обнаружена и устранена ошибка `API Routes cannot be used with "output: export"` в проекте с анкетой, мешавшая его запуску.
* **Код:**
    * **Проект «Анкета» (`trimspire-clone`):** Удалена неиспользуемая папка `src/pages/api`, что устранило ошибку при запуске сервера разработки.
    * **Проект «Генератор меню» (`trimspire-menu-generator`):**
        * Файл `middleware.ts` был удален, чтобы избежать дальнейшей путаницы.
        * В файл `src/pages/dashboard.tsx` добавлена функция `getServerSideProps`. Внутри нее реализована логика проверки наличия и валидности `auth_token` из cookie. Если проверка не проходит, пользователь принудительно перенаправляется на страницу `/login` на стороне сервера.

### Результат
* **Успех.** Система защиты страниц полностью исправлена и работает надежно. Страница `/dashboard` теперь недоступна для неавторизованных пользователей. Проблема с запуском второго проекта также решена.